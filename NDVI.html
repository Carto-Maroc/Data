<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ø³ØªØ®Ø±Ø§Ø¬ NDVI Ù…Ù† Landsat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-y: auto;
            direction: rtl;
        }
        
        .sidebar h1 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .sidebar h2 {
            color: #764ba2;
            font-size: 14px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: normal;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            direction: ltr;
            text-align: left;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .map-container {
            flex: 1;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .status.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }
        
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .instructions h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-right: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
            color: #666;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .satellite-info {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .leaflet-draw-toolbar a {
            background-color: white !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>ğŸ›°ï¸ Ù…Ù†ØµØ© NDVI</h1>
            <h2>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¤Ø´Ø± Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ Ù…Ù† Landsat</h2>
            
            <div class="instructions">
                <h3>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3>
                <ol>
                    <li>Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©</li>
                    <li>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ (Landsat 8 Ø£Ùˆ 9)</li>
                    <li>Ø§Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</li>
                    <li>Ø§Ù†Ù‚Ø± "Ø­Ø³Ø§Ø¨ NDVI"</li>
                    <li>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© GeoTIFF</li>
                </ol>
            </div>
            
            <div id="status" class="status"></div>
            
            <div class="form-group">
                <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                <input type="date" id="startDate" required>
            </div>
            
            <div class="form-group">
                <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                <input type="date" id="endDate" required>
            </div>
            
            <div class="form-group">
                <label>ğŸ›°ï¸ Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</label>
                <select id="satellite">
                    <option value="LANDSAT/LC08/C02/T1_L2">Landsat 8 (2013-Ø§Ù„Ø¢Ù†)</option>
                    <option value="LANDSAT/LC09/C02/T1_L2">Landsat 9 (2021-Ø§Ù„Ø¢Ù†)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>â˜ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØºÙŠÙˆÙ… (%)</label>
                <input type="number" id="cloudCover" value="20" min="0" max="100">
            </div>
            
            <button class="btn btn-primary" id="calculateBtn" disabled>
                Ø­Ø³Ø§Ø¨ NDVI
            </button>
            
            <button class="btn btn-secondary" id="clearBtn">
                Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…
            </button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
            
            <div class="satellite-info">
                <strong>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:</strong><br>
                â€¢ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ©: 30 Ù…ØªØ±<br>
                â€¢ ØµÙŠØºØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„: GeoTIFF<br>
                â€¢ NDVI = (NIR - Red) / (NIR + Red)
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([31.7917, -7.0926], 6);
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Initialize drawing layer
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Drawing controls
        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    drawError: {
                        color: '#e74c3c',
                        message: '<strong>Ø®Ø·Ø£!</strong> Ø§Ù„Ø´ÙƒÙ„ ØºÙŠØ± ØµØ§Ù„Ø­.'
                    },
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3
                    }
                },
                circle: false,
                marker: false,
                circlemarker: false,
                polyline: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);
        
        // Global variables
        let currentPolygon = null;
        let ndviImageUrl = null;
        
        // Handle drawing created
        map.on(L.Draw.Event.CREATED, function(e) {
            drawnItems.clearLayers();
            const layer = e.layer;
            drawnItems.addLayer(layer);
            currentPolygon = layer.toGeoJSON();
            
            document.getElementById('calculateBtn').disabled = false;
            showStatus('ØªÙ… Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        });
        
        // Handle drawing deleted
        map.on(L.Draw.Event.DELETED, function() {
            currentPolygon = null;
            document.getElementById('calculateBtn').disabled = true;
            showStatus('ØªÙ… Ù…Ø³Ø­ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©', 'warning');
        });
        
        // Clear button handler
        document.getElementById('clearBtn').addEventListener('click', function() {
            drawnItems.clearLayers();
            currentPolygon = null;
            document.getElementById('calculateBtn').disabled = true;
            showStatus('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª', 'info');
        });
        
        // Calculate NDVI button handler
        document.getElementById('calculateBtn').addEventListener('click', async function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const satellite = document.getElementById('satellite').value;
            const cloudCover = document.getElementById('cloudCover').value;
            
            if (!startDate || !endDate) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'error');
                return;
            }
            
            if (!currentPolygon) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            showStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®ÙˆØ§Ø¯Ù… Google Earth Engine...', 'info');
            
            // Prepare Google Earth Engine code
            const geeCode = generateGEECode(startDate, endDate, satellite, cloudCover, currentPolygon);
            
            // Display code for user to run in GEE
            displayGEEInstructions(geeCode);
        });
        
        // Generate Google Earth Engine code
        function generateGEECode(startDate, endDate, satellite, cloudCover, polygon) {
            const coordinates = polygon.geometry.coordinates[0];
            const coordsString = coordinates.map(coord => `[${coord[0]}, ${coord[1]}]`).join(',\n        ');
            
            return `// ÙƒÙˆØ¯ Ø§Ø³ØªØ®Ø±Ø§Ø¬ NDVI Ù…Ù† Landsat
// ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù…Ù†ØµØ© NDVI

// ØªØ¹Ø±ÙŠÙ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©
var geometry = ee.Geometry.Polygon([
    [
        ${coordsString}
    ]
]);

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
Map.centerObject(geometry, 10);
Map.addLayer(geometry, {color: 'red'}, 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©');

// ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Landsat
var collection = ee.ImageCollection('${satellite}')
    .filterBounds(geometry)
    .filterDate('${startDate}', '${endDate}')
    .filter(ee.Filter.lt('CLOUD_COVER', ${cloudCover}));

print('Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©:', collection.size());

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ NDVI Ù„Ù€ Landsat 8/9
function calculateNDVI(image) {
    var nir = image.select('SR_B5'); // Near-Infrared
    var red = image.select('SR_B4'); // Red
    
    var ndvi = nir.subtract(red)
        .divide(nir.add(red))
        .rename('NDVI');
    
    return image.addBands(ndvi);
}

// Ø­Ø³Ø§Ø¨ NDVI Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
var ndviCollection = collection.map(calculateNDVI);

// Ø£Ø®Ø° Ù…ØªÙˆØ³Ø· NDVI Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
var ndviMean = ndviCollection.select('NDVI').median().clip(geometry);

// Ø¹Ø±Ø¶ NDVI Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
var ndviVis = {
    min: -1,
    max: 1,
    palette: ['red', 'yellow', 'green']
};

Map.addLayer(ndviMean, ndviVis, 'NDVI');

// ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© GeoTIFF
Export.image.toDrive({
    image: ndviMean,
    description: 'NDVI_Export_${startDate}_to_${endDate}',
    folder: 'NDVI_Results',
    fileNamePrefix: 'NDVI_${startDate}',
    region: geometry,
    scale: 30,
    crs: 'EPSG:4326',
    fileFormat: 'GeoTIFF',
    maxPixels: 1e13
});

print('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Tasks ÙˆØ§Ù†Ù‚Ø± Ø¹Ù„Ù‰ RUN');`;
        }
        
        // Display GEE instructions
        function displayGEEInstructions(code) {
            document.getElementById('loading').style.display = 'none';
            
            // Create modal with code
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; max-height: 90vh; overflow-y: auto; direction: rtl;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“ ÙƒÙˆØ¯ Google Earth Engine</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #764ba2; font-size: 16px; margin-bottom: 10px;">Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°:</h3>
                        <ol style="margin-right: 20px; line-height: 1.8;">
                            <li>Ø§ÙØªØ­ <a href="https://code.earthengine.google.com" target="_blank" style="color: #667eea;">Google Earth Engine Code Editor</a></li>
                            <li>Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¯Ù†Ø§Ù‡</li>
                            <li>Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</li>
                            <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Run"</li>
                            <li>Ø§Ù†ØªØ¸Ø± Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</li>
                            <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ "Tasks" ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰</li>
                            <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "RUN" Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© GeoTIFF</li>
                            <li>Ø³ØªØ¬Ø¯ Ø§Ù„Ù…Ù„Ù ÙÙŠ Google Drive ÙÙŠ Ù…Ø¬Ù„Ø¯ "NDVI_Results"</li>
                        </ol>
                    </div>
                    
                    <div style="position: relative; margin-bottom: 20px;">
                        <pre style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto; direction: ltr; text-align: left; font-size: 13px; line-height: 1.5;">${escapeHtml(code)}</pre>
                        <button onclick="copyCode()" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
                    </div>
                    
                    <button onclick="closeModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store code for copying
            window.currentGEECode = code;
            
            // Close modal function
            window.closeModal = function() {
                document.body.removeChild(modal);
                showStatus('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­. Ø§ÙØªØ­ Google Earth Engine Ù„ØªÙ†ÙÙŠØ°Ù‡', 'success');
            };
            
            // Copy code function
            window.copyCode = function() {
                navigator.clipboard.writeText(window.currentGEECode).then(function() {
                    showStatus('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
                });
            };
        }
        
        // Escape HTML for display
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Set default dates (last 3 months)
        const today = new Date();
        const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
        
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('startDate').valueAsDate = threeMonthsAgo;
    </script>
</body>
</html>
